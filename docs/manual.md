# ISUCON11 本選当日マニュアル

TODO: レギュレーション相当の内容を追加する。

## スケジュール

- 10:00 競技開始
- 17:00 リーダーボードの更新停止
- 18:00 競技終了
- 翌 19:00 結果発表イベント開始

## 課題アプリケーション ISUCHOLAR について

課題アプリケーション ISUCHOLAR の仕様については、[ISUCHOLAR アプリケーションマニュアル](https://gist.github.com/motoki317/8fbca140c489025ceb644ab467662371) を参照してください。

## ISUCON11 ポータルサイト（ポータル）

ISUCON11 の競技では下記のウェブサイトを利用します。事前に登録した情報を用いてログインしてください。
なお、このページは競技開始時刻までアクセスすることはできません。

ポータルでは、負荷走行（ベンチマーク）の実行/結果確認、質問/サポート依頼（以後、質問）の送信、リーダーボードの確認ができます。

https://portal.isucon.net/contestant

### リーダーボードの更新について

ポータル上のリーダーボードは、競技終了 1 時間前に他チームの情報が更新されなくなり、自チームの情報のみ更新されます。

## Discord の利用について

ISUCON11 サポート Discord サーバーは競技中ならびにその前後の時間はすべてのチャンネルが発言不可となります。
競技時間中はポータルを通して質問/サポート依頼を送信することができますので、そちらを利用してください。

ただし、本選参加者（以下選手）は競技時間中も Discord の確認が可能な状態、通知が受け取れる状態を維持してください。
これは主催者が選手とリアルタイムでのチャットが必要だと判断した場合、主催者が Discord 上でプライベートチャンネルを作成しメンションの上、呼びかけを行う場合があるためです。呼びかけに応じない場合、競技に支障をきたす可能性があるため、必ず応答可能な状態を維持してください。

また、主催者からのアナウンス等も Discord で実施されます。

## 質問について

選手は主催者へ質問を送信することができます。質問は競技内容・マニュアル・レギュレーション等に対する疑問点の確認や、サーバー障害などのトラブル報告・サポート依頼に利用することができますが、これに限りません。

主催者は質問された内容が競技の一環である場合は、回答できない旨を返答することがあります。

競技時間中の質問について、主催者からの回答は全選手へ公開、あるいは個別に回答されます。全選手へ公開される場合、質問内容の原文、あるいは主催者による内容の要約が公開されます。未回答の質問・未公開の回答については質問した選手およびそのチームメンバー、主催者のみが確認できます。質問への回答・更新はポータル上にて選手およびそのチームへ通知されます。

主催者は競技時間中の質問への回答を、原則として全選手へ公開します。ただし、重複する質問や、選手およびチーム個別の問題に対する対応の場合、この限りではありません。

### サポート対象外の事項

主催者が事前に Discord サーバー等で告知していた通り、下記はサポート対象外となります。

- スポンサー各社が提供しているサービスについての質問

## 競技環境について

本選では、競技に必要なすべてのサーバーを主催者が用意します。

### サーバー、ネットワーク構成について

事前に用意されたサーバは 3 台あり（以下、競技用サーバー）、これらのサーバに SSH 接続し競技を行います。
ポータル右上に表示されているチームIDをもとに、[競技環境情報](https://gist.github.com/motoki317/799787c6189ca36d48df1b9e52617747) 


### 競技環境の再起動あるいは初期化について

選手自らが設定変更等により競技環境を破壊するなどして、主催者による再起動あるいは初期化が必要になった場合はポータルからサポートを依頼してください。
初期化以前の競技環境上で変更を加えたソースコードや設定ファイル等の移行が必要な場合は、各チームの責任で行ってください。

### 重要事項

- **競技に利用できる計算機資源は主催者が用意した 3 台のサーバーのみです。**
  - レギュレーションに記載した通り、モニタリングやテスト、開発において外部の資源を用いても構いませんが（例： メトリクス計測サービス）、スコアを向上させるいかなる効果を持つものであってはいけません。
- **競技終了後は、主催者が追試を行います。Discord サーバー および [ISUCON 公式Blog](https://isucon.net/) にて主催者がアナウンスをするまで、競技環境の操作はしないでください。**
  - 競技終了後、別途アナウンスがあるまでに作業を行ったチームは失格となります。
- **その他、主催者による追試を妨げる変更（例： サーバー上の `isucon` 以外のユーザに関する、ユーザ削除や既存の公開鍵の削除）を行ってはいけません。**

## アプリケーションの動作確認

ISUCHOLAR は Web ブラウザから利用することができます。
サーバーのポートはSSH接続用の 22 番以外開放されていないため、ブラウザを使って動作確認する場合は SSH を使ったローカルポートフォワーディングなどを利用してください。

以下に SSH を使ってローカルポートフォワーディングする例を示します。
これは「リモートホスト `192.0.2.1` に ユーザー名 `isucon` で SSH 接続をして」、その間は「ローカルから見た localhost:8080 への TCP 接続を」「リモートホストから見た localhost:80 へ転送する」というコマンドです。

```
ssh -L localhost:8080:localhost:80 isucon@192.0.2.1
```

以上を踏まえると、上記のコマンドで SSH 接続している間は http://localhost:8080 でリモートホストの 80 番ポートで起動しているアプリケーションにアクセスすることができます。

### ISUCHOLAR へのログイン

ISUCHOLAR には、学籍番号とパスワードを使ってログインできます。

ベンチマーカーは、学生・教員の 1 人としてそれぞれ以下の `S00000`・`T00000` を必ず利用します。
`S00000`・`T00000` ユーザーを用いることで、負荷走行後のアプリケーションの状態確認が可能です。

|        | 学籍番号  | パスワード  |
| ------ | -------- | ---------- |
| 学生   | S00000   | isucon     |
| 教員   | T00000   | isucon     |

なお、初期状態ではユーザー以外のデータは存在しません。

## 負荷走行 （ベンチマーク） の実行

負荷走行はポータル上からリクエストします。

[ポータル](https://portal.isucon.net/contestant) にアクセスし、「Job Enqueue Form」から負荷走行対象のサーバーを選択、「Enqueue」をクリックすることで負荷走行をリクエストできます。

なお、負荷走行が待機中（PENDING）もしくは実行中（RUNNING）の間は追加でリクエストを行うことはできません。

## 参考実装

下記の言語での実装が提供されています。

- Go
- Node.js
- PHP
- Ruby
- Rust

### 参考実装の切り替え方法

初期状態では Go による実装が起動しています。

各言語実装は systemd で管理されています。
例えば、参考実装を Go から Ruby に切り替えるには以下のコマンドを実行します。

```shell
sudo systemctl disable --now isucholar.go.service

sudo systemctl enable --now isucholar.ruby.service
```

#### PHP への切り替え

ただし、PHP を使う場合のみ、systemd の設定変更の他に、次のように nginx の設定ファイルの変更が必要です。

```shell
sudo unlink /etc/nginx/sites-enabled/isucholar.conf
sudo ln -s /etc/nginx/sites-available/isucholar-php.conf /etc/nginx/sites-enabled/isucholar-php.conf
sudo systemctl restart nginx.service
```

### アプリケーションのデータの初期化処理について

参考実装では、初期化処理（`POST /initialize`）においてデータベースを初期状態に戻します。
サーバーサイドで処理の変更・データ構造の変更などを行う場合は、動作に支障が無いように変更してください。

## 負荷走行について

ベンチマーカーによる負荷走行は以下のように実施されます。

1. 初期化処理の実行 `POST /initialize`（最大 20 秒）
2. アプリケーション互換性チェック（数秒～数十秒）
3. 初期化処理の実行 `POST /initialize`（最大 20 秒）
4. 負荷走行（60 秒）
5. リトライ処理（最大 5 秒）
6. 待ち時間（最大 5 秒）
7. 整合性チェック（数秒～数十秒）

ベンチマーカーは負荷走行終了後、最大10秒待ってから整合性チェックを行います。
この間に、負荷走行中タイムアウトしたリクエストのリトライを行うことがあります。

初期化処理、アプリケーション互換性チェック、整合性チェックのいずれか一つでも失敗すると、負荷走行は即時失敗（fail）になります。

### リダイレクトについて

ベンチマーカーは HTTP リダイレクトを処理しません。

### キャッシュについて

ベンチマーカーは下記を除き、データの更新が即時反映されていることを期待して検証を行います。
ただし、アプリケーションはベンチマーカーが検知しない限りは古い情報を返しても構いません。

#### TODO: 土曜日の感触次第で成績確認周りのキャッシュの許容について書く。

#### Conditional GET のサポートについて

ベンチマーカーは一般的なブラウザの挙動を模した [Conditional GET](https://tools.ietf.org/html/rfc7232) に対応しています。
アプリケーションは、 `Cache-Control` やその他必要なレスポンスヘッダを返すことで、ベンチマーカーから Conditional GET リクエストを受けることができます。
データが更新されていないことが期待されるリクエストにおいては、`304 Not Modified` を返したり、あるいはブラウザのキャッシュ有効期限の制御によってリクエストが発生していない場合も、ベンチマーカーはそれらのキャッシュを利用してレスポンスがあったものとみなします。

なお、ベンチマーカー内のユーザは独立しているため、 `Cache-Control: public` 等が指定されていたとしても、ユーザ同士でキャッシュを共有することはありません。

### 誤差について

成績確認(`GET /users/me/grades`)のレスポンスに含まれる以下の値については、`0.01` 以下の絶対誤差を許容します。

- 科目の総合点の平均・偏差値
- GPAの値・最大値・最小値・平均・偏差値

### タイムアウトについて

負荷走行において設定されているタイムアウト値は下記の通りです。

- `POST /initialize`
  - 20 秒以内にレスポンスを返す必要があります。これを超えた場合、負荷走行は即時失敗（fail）します。
- 上記以外の HTTP リクエスト
  - 5 秒以内にレスポンスを返す必要があります。これを超えた場合、後述のスコア計算に従い減点の対象となります。

## スコア計算

アプリケーション互換性チェックを通過し負荷走行が開始されると、下記の通り加点・減点が行われます。
加点対象のリクエストは、負荷走行中に送信されたリクエストのみです。[負荷走行について](## 負荷走行について)
アプリケーション互換性チェックや、リトライ処理で送信されたリクエストは加点対象ではありません。

### 負荷走行時における加点について

- 課題の提出
  - 1 回あたり 5 点
- 成績の確認
  - 1 回あたり 1 点
- お知らせ一覧の取得
  - 2 回あたり 1 点

### 負荷走行時における減点、即時失敗（fail）について

下記のエラーは減点や即時失敗（fail）となります。fail となった場合スコアは 0 点となります。

- 初期化処理、アプリケーション互換性チェック、整合性チェックのいずれかに失敗した場合
  - 1 回以上で fail

- HTTP ステータスコードやレスポンス内容などに誤りがある場合
  - 1 回あたり減点 50 点
  - 100 回を超えた時点で fail

- リクエストがタイムアウトした場合（[タイムアウトについて](#タイムアウトについて)）
  - 100 回あたり減点 100 点
  - fail は発生しない

### 特別賞

TODO: 後で決める。中盤(14:00頃)に出そうな点数。
- 競技中のスコアが、最初に xxx を超えた 1 チームを特別賞とします。

### 最終スコア

競技終了後、主催者は **全サーバーの再起動後に負荷走行を実施** します。
その際のスコアを最終スコアとします。

#### 追試

最終スコアが確定後、主催者による確認作業（追試）を行います。下記の点が確認できなかった場合は fail となります。

- 負荷走行実行時にアプリケーションに書き込まれたデータはサーバー再起動後にも取得できること
- アプリケーションはブラウザ上での挙動を初期状態と同様に保っていること

#### TODO: 追試手順を書く

### その他

#### `POST /initialize` での実装言語の出力

`POST /initialize` レスポンスにて、本競技で利用した言語を出力してください。
参考実装はそのようになっています。
この情報は集計し [ISUCON 公式Blog](https://isucon.net/) での公表や、参考情報として利用させていただきます。

`POST /initialize` のレスポンスは以下のような JSON となります。

```json
{
    "language": "実装言語"
}
```

`language` の値が実装に利用した言語となります。
`language` が空の場合は初期化処理が失敗と見なされます。

## 禁止事項

以下の行為を特に禁止する。

- 競技終了時間までに、競技の内容に関するあらゆる事項（問題内容・計測ツールの計測方法など）を公開・共有すること（内容を推察できる発言も含む）
  - 不特定多数への公開はもちろん、他チームの選手と連絡を取り、問題内容等を共有する事（結託行為）も禁止とする。
  - ただし主催者が Twitter, Web サイトにおいて公開している情報は除く。ポータルでログインを要するページ（選手が参加する Discord を含む）において記載されている内容は公開情報でない旨留意すること
- 競技時間中、チーム外の人物と ISUCON11 問題にまつわる事項のやりとり（ISUCON11 選手であるかどうかを問わない、SNS での発言も含む）
- 主催者の指示以外で利用が認められたサーバー以外の外部リソースを使用する行為（他のインスタンスに処理を委譲するなど) は禁止する。
  - ただしモニタリングやテスト、開発などにおいては、PC や外部のサーバーを利用しても構わない。
- 選手が主催者からその選手が属するチームへ提供されていないサーバーについて直接のアクセスを試みる行為や、外部への不正アクセスを試みる行為。具体的にはベンチマーカーへのログイン試行等。（なお、例示のため、これに限らない）
- 他チームと結託する行為（程度を問わず）
- 主催者が他チームへの妨害、競技への支障となるとみなす全ての行為

本マニュアルやレギュレーション、ポータルにおいて禁止とされた行為（禁止事項）への違反は、失格となる。
